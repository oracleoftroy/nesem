#include "color_palette.hpp"

#include <array>
#include <fstream>

#include <util/logging.hpp>

namespace app
{
	std::array<cm::Color, 512> default_colors{
		cm::Color{77,  77,  77 },
		cm::Color{0,   25,  108},
		cm::Color{10,  9,   142},
		cm::Color{38,  0,   138},
		cm::Color{66,  0,   98 },
		cm::Color{82,  0,   41 },
		cm::Color{80,  3,   0  },
		cm::Color{60,  15,  0  },
		cm::Color{31,  32,  0  },
		cm::Color{5,   48,  0  },
		cm::Color{0,   56,  0  },
		cm::Color{0,   54,  3  },
		cm::Color{0,   42,  53 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{156, 156, 156},
		cm::Color{11,  71,  204},
		cm::Color{46,  44,  255},
		cm::Color{93,  24,  249},
		cm::Color{137, 15,  188},
		cm::Color{163, 18,  99 },
		cm::Color{160, 31,  18 },
		cm::Color{129, 55,  0  },
		cm::Color{82,  84,  0  },
		cm::Color{36,  109, 0  },
		cm::Color{6,   122, 0  },
		cm::Color{0,   118, 32 },
		cm::Color{0,   99,  117},
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{254, 255, 255},
		cm::Color{78,  157, 255},
		cm::Color{125, 122, 255},
		cm::Color{182, 96,  255},
		cm::Color{234, 84,  255},
		cm::Color{255, 87,  189},
		cm::Color{255, 106, 89 },
		cm::Color{224, 137, 21 },
		cm::Color{169, 172, 0  },
		cm::Color{113, 202, 0  },
		cm::Color{70,  217, 31 },
		cm::Color{49,  212, 107},
		cm::Color{52,  190, 211},
		cm::Color{55,  55,  55 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{254, 255, 255},
		cm::Color{176, 213, 255},
		cm::Color{199, 197, 255},
		cm::Color{224, 185, 255},
		cm::Color{246, 179, 255},
		cm::Color{255, 181, 227},
		cm::Color{255, 190, 182},
		cm::Color{242, 204, 145},
		cm::Color{218, 220, 126},
		cm::Color{193, 232, 128},
		cm::Color{172, 239, 151},
		cm::Color{162, 237, 190},
		cm::Color{163, 227, 236},
		cm::Color{165, 165, 165},
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{78,  45,  41 },
		cm::Color{0,   5,   64 },
		cm::Color{10,  0,   93 },
		cm::Color{36,  0,   93 },
		cm::Color{62,  0,   64 },
		cm::Color{79,  0,   22 },
		cm::Color{80,  0,   0  },
		cm::Color{60,  5,   0  },
		cm::Color{32,  16,  0  },
		cm::Color{7,   25,  0  },
		cm::Color{0,   29,  0  },
		cm::Color{0,   25,  0  },
		cm::Color{0,   15,  20 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{157, 103, 96 },
		cm::Color{12,  35,  133},
		cm::Color{45,  17,  178},
		cm::Color{90,  6,   178},
		cm::Color{132, 3,   133},
		cm::Color{159, 6,   65 },
		cm::Color{160, 19,  6  },
		cm::Color{129, 35,  0  },
		cm::Color{84,  54,  0  },
		cm::Color{40,  71,  0  },
		cm::Color{10,  77,  0  },
		cm::Color{0,   71,  4  },
		cm::Color{0,   52,  62 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{255, 177, 167},
		cm::Color{80,  96,  209},
		cm::Color{125, 73,  255},
		cm::Color{179, 56,  255},
		cm::Color{229, 50,  209},
		cm::Color{255, 56,  131},
		cm::Color{255, 75,  55 },
		cm::Color{225, 96,  3  },
		cm::Color{172, 120, 0  },
		cm::Color{118, 140, 0  },
		cm::Color{77,  148, 3  },
		cm::Color{54,  140, 52 },
		cm::Color{53,  118, 127},
		cm::Color{56,  29,  26 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{255, 177, 167},
		cm::Color{178, 142, 184},
		cm::Color{200, 132, 204},
		cm::Color{224, 124, 204},
		cm::Color{245, 121, 184},
		cm::Color{255, 124, 152},
		cm::Color{255, 133, 118},
		cm::Color{243, 142, 87 },
		cm::Color{221, 153, 71 },
		cm::Color{197, 161, 71 },
		cm::Color{177, 165, 87 },
		cm::Color{166, 161, 116},
		cm::Color{165, 152, 150},
		cm::Color{166, 109, 102},
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{36,  69,  26 },
		cm::Color{0,   20,  59 },
		cm::Color{0,   5,   81 },
		cm::Color{9,   0,   76 },
		cm::Color{27,  0,   44 },
		cm::Color{41,  0,   7  },
		cm::Color{42,  1,   0  },
		cm::Color{29,  12,  0  },
		cm::Color{10,  28,  0  },
		cm::Color{0,   44,  0  },
		cm::Color{0,   54,  0  },
		cm::Color{0,   49,  0  },
		cm::Color{0,   36,  20 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{88,  142, 72 },
		cm::Color{0,   63,  123},
		cm::Color{12,  36,  159},
		cm::Color{43,  17,  150},
		cm::Color{73,  8,   100},
		cm::Color{96,  12,  37 },
		cm::Color{97,  26,  0  },
		cm::Color{77,  49,  0  },
		cm::Color{44,  77,  0  },
		cm::Color{13,  103, 0  },
		cm::Color{0,   118, 0  },
		cm::Color{0,   111, 4  },
		cm::Color{0,   90,  61 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{156, 235, 131},
		cm::Color{31,  143, 190},
		cm::Color{62,  109, 229},
		cm::Color{102, 83,  220},
		cm::Color{138, 69,  163},
		cm::Color{165, 76,  90 },
		cm::Color{166, 95,  23 },
		cm::Color{143, 126, 0  },
		cm::Color{104, 160, 0  },
		cm::Color{64,  190, 0  },
		cm::Color{35,  207, 0  },
		cm::Color{17,  199, 44 },
		cm::Color{16,  175, 118},
		cm::Color{22,  48,  14 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{156, 235, 131},
		cm::Color{100, 196, 155},
		cm::Color{115, 181, 170},
		cm::Color{133, 169, 166},
		cm::Color{149, 162, 144},
		cm::Color{160, 165, 114},
		cm::Color{160, 174, 82 },
		cm::Color{151, 188, 57 },
		cm::Color{134, 204, 45 },
		cm::Color{116, 216, 48 },
		cm::Color{102, 224, 66 },
		cm::Color{92,  220, 93 },
		cm::Color{91,  210, 126},
		cm::Color{95,  151, 77 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{42,  42,  21 },
		cm::Color{0,   4,   48 },
		cm::Color{0,   0,   69 },
		cm::Color{11,  0,   66 },
		cm::Color{28,  0,   41 },
		cm::Color{43,  0,   5  },
		cm::Color{43,  0,   0  },
		cm::Color{31,  3,   0  },
		cm::Color{12,  13,  0  },
		cm::Color{0,   23,  0  },
		cm::Color{0,   28,  0  },
		cm::Color{0,   24,  0  },
		cm::Color{0,   14,  14 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{98,  98,  62 },
		cm::Color{0,   33,  106},
		cm::Color{17,  16,  139},
		cm::Color{47,  5,   135},
		cm::Color{76,  1,   96 },
		cm::Color{99,  4,   34 },
		cm::Color{100, 16,  0  },
		cm::Color{80,  31,  0  },
		cm::Color{48,  50,  0  },
		cm::Color{19,  67,  0  },
		cm::Color{1,   76,  0  },
		cm::Color{0,   69,  0  },
		cm::Color{0,   51,  51 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{170, 170, 116},
		cm::Color{41,  93,  166},
		cm::Color{72,  70,  203},
		cm::Color{110, 53,  199},
		cm::Color{144, 45,  155},
		cm::Color{171, 51,  84 },
		cm::Color{173, 69,  18 },
		cm::Color{149, 90,  0  },
		cm::Color{112, 114, 0  },
		cm::Color{73,  134, 0  },
		cm::Color{44,  144, 0  },
		cm::Color{25,  137, 33 },
		cm::Color{24,  115, 104},
		cm::Color{26,  27,  10 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{170, 170, 116},
		cm::Color{112, 137, 136},
		cm::Color{127, 127, 151},
		cm::Color{144, 118, 149},
		cm::Color{159, 114, 132},
		cm::Color{170, 117, 102},
		cm::Color{171, 126, 71 },
		cm::Color{161, 136, 50 },
		cm::Color{145, 147, 39 },
		cm::Color{128, 155, 40 },
		cm::Color{114, 160, 53 },
		cm::Color{104, 156, 79 },
		cm::Color{103, 147, 111},
		cm::Color{104, 105, 67 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{49,  48,  100},
		cm::Color{0,   13,  117},
		cm::Color{4,   3,   150},
		cm::Color{24,  0,   143},
		cm::Color{44,  0,   105},
		cm::Color{54,  0,   51 },
		cm::Color{50,  0,   5  },
		cm::Color{32,  1,   0  },
		cm::Color{9,   10,  0  },
		cm::Color{0,   23,  0  },
		cm::Color{0,   31,  0  },
		cm::Color{0,   32,  14 },
		cm::Color{0,   25,  64 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   4  },
		cm::Color{0,   0,   4  },
		cm::Color{110, 109, 193},
		cm::Color{4,   51,  219},
		cm::Color{34,  31,  255},
		cm::Color{69,  13,  255},
		cm::Color{101, 5,   201},
		cm::Color{118, 4,   116},
		cm::Color{111, 11,  37 },
		cm::Color{83,  26,  0  },
		cm::Color{43,  44,  0  },
		cm::Color{13,  67,  0  },
		cm::Color{0,   81,  1  },
		cm::Color{0,   82,  54 },
		cm::Color{0,   70,  137},
		cm::Color{0,   0,   4  },
		cm::Color{0,   0,   4  },
		cm::Color{0,   0,   4  },
		cm::Color{187, 186, 255},
		cm::Color{55,  118, 255},
		cm::Color{97,  94,  255},
		cm::Color{140, 69,  255},
		cm::Color{178, 55,  255},
		cm::Color{197, 54,  221},
		cm::Color{189, 66,  124},
		cm::Color{156, 86,  54 },
		cm::Color{109, 110, 21 },
		cm::Color{68,  138, 27 },
		cm::Color{39,  154, 67 },
		cm::Color{26,  155, 145},
		cm::Color{31,  141, 245},
		cm::Color{32,  32,  74 },
		cm::Color{0,   0,   4  },
		cm::Color{0,   0,   4  },
		cm::Color{187, 186, 255},
		cm::Color{128, 157, 255},
		cm::Color{148, 146, 255},
		cm::Color{167, 134, 255},
		cm::Color{183, 128, 255},
		cm::Color{191, 128, 255},
		cm::Color{188, 133, 228},
		cm::Color{174, 143, 192},
		cm::Color{154, 154, 173},
		cm::Color{135, 166, 177},
		cm::Color{120, 173, 200},
		cm::Color{113, 173, 238},
		cm::Color{116, 167, 255},
		cm::Color{117, 116, 203},
		cm::Color{0,   0,   4  },
		cm::Color{0,   0,   4  },
		cm::Color{48,  33,  54 },
		cm::Color{0,   3,   69 },
		cm::Color{4,   0,   98 },
		cm::Color{22,  0,   95 },
		cm::Color{40,  0,   68 },
		cm::Color{51,  0,   29 },
		cm::Color{50,  0,   0  },
		cm::Color{32,  0,   0  },
		cm::Color{9,   6,   0  },
		cm::Color{0,   15,  0  },
		cm::Color{0,   20,  0  },
		cm::Color{0,   18,  0  },
		cm::Color{0,   11,  24 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{108, 82,  117},
		cm::Color{3,   29,  141},
		cm::Color{33,  13,  186},
		cm::Color{65,  2,   182},
		cm::Color{96,  0,   140},
		cm::Color{113, 0,   77 },
		cm::Color{111, 6,   20 },
		cm::Color{83,  19,  0  },
		cm::Color{43,  37,  0  },
		cm::Color{14,  53,  0  },
		cm::Color{0,   61,  0  },
		cm::Color{0,   59,  13 },
		cm::Color{0,   46,  69 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{185, 147, 199},
		cm::Color{53,  83,  225},
		cm::Color{95,  61,  255},
		cm::Color{135, 44,  255},
		cm::Color{171, 37,  225},
		cm::Color{191, 39,  152},
		cm::Color{188, 51,  80 },
		cm::Color{156, 70,  19 },
		cm::Color{108, 93,  0  },
		cm::Color{70,  112, 0  },
		cm::Color{41,  122, 20 },
		cm::Color{28,  119, 71 },
		cm::Color{29,  105, 142},
		cm::Color{31,  19,  36 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{185, 147, 199},
		cm::Color{127, 120, 210},
		cm::Color{146, 110, 230},
		cm::Color{164, 102, 228},
		cm::Color{179, 98,  209},
		cm::Color{188, 99,  179},
		cm::Color{187, 105, 147},
		cm::Color{173, 114, 115},
		cm::Color{152, 124, 98 },
		cm::Color{135, 132, 99 },
		cm::Color{121, 137, 115},
		cm::Color{113, 135, 143},
		cm::Color{114, 129, 175},
		cm::Color{115, 88,  125},
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{29,  44,  46 },
		cm::Color{0,   10,  67 },
		cm::Color{0,   1,   89 },
		cm::Color{8,   0,   83 },
		cm::Color{24,  0,   50 },
		cm::Color{34,  0,   15 },
		cm::Color{33,  0,   0  },
		cm::Color{21,  0,   0  },
		cm::Color{5,   9,   0  },
		cm::Color{0,   22,  0  },
		cm::Color{0,   30,  0  },
		cm::Color{0,   28,  0  },
		cm::Color{0,   21,  30 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{76,  101, 104},
		cm::Color{0,   44,  137},
		cm::Color{10,  26,  172},
		cm::Color{39,  8,   163},
		cm::Color{69,  1,   111},
		cm::Color{85,  2,   53 },
		cm::Color{83,  10,  3  },
		cm::Color{63,  24,  0  },
		cm::Color{34,  42,  0  },
		cm::Color{6,   65,  0  },
		cm::Color{0,   79,  0  },
		cm::Color{0,   76,  20 },
		cm::Color{0,   63,  78 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{138, 175, 180},
		cm::Color{27,  108, 217},
		cm::Color{55,  84,  255},
		cm::Color{94,  60,  246},
		cm::Color{129, 47,  188},
		cm::Color{148, 49,  119},
		cm::Color{145, 61,  52 },
		cm::Color{122, 82,  8  },
		cm::Color{87,  105, 0  },
		cm::Color{49,  132, 0  },
		cm::Color{22,  149, 24 },
		cm::Color{10,  146, 78 },
		cm::Color{12,  130, 149},
		cm::Color{16,  28,  30 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{138, 175, 180},
		cm::Color{87,  146, 195},
		cm::Color{102, 136, 210},
		cm::Color{119, 124, 206},
		cm::Color{134, 118, 183},
		cm::Color{142, 119, 154},
		cm::Color{141, 125, 123},
		cm::Color{131, 135, 98 },
		cm::Color{116, 145, 85 },
		cm::Color{99,  157, 88 },
		cm::Color{85,  164, 108},
		cm::Color{78,  163, 135},
		cm::Color{79,  156, 167},
		cm::Color{82,  108, 111},
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{33,  33,  33 },
		cm::Color{0,   3,   52 },
		cm::Color{0,   0,   73 },
		cm::Color{9,   0,   71 },
		cm::Color{26,  0,   46 },
		cm::Color{36,  0,   11 },
		cm::Color{34,  0,   0  },
		cm::Color{22,  0,   0  },
		cm::Color{6,   6,   0  },
		cm::Color{0,   15,  0  },
		cm::Color{0,   20,  0  },
		cm::Color{0,   18,  0  },
		cm::Color{0,   11,  18 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{82,  82,  82 },
		cm::Color{0,   29,  114},
		cm::Color{14,  13,  147},
		cm::Color{42,  2,   143},
		cm::Color{71,  0,   104},
		cm::Color{87,  0,   46 },
		cm::Color{85,  6,   0  },
		cm::Color{65,  19,  0  },
		cm::Color{36,  37,  0  },
		cm::Color{9,   53,  0  },
		cm::Color{0,   61,  0  },
		cm::Color{0,   59,  6  },
		cm::Color{0,   46,  58 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{147, 147, 147},
		cm::Color{33,  83,  183},
		cm::Color{63,  61,  220},
		cm::Color{100, 44,  216},
		cm::Color{133, 37,  171},
		cm::Color{152, 39,  104},
		cm::Color{150, 51,  40 },
		cm::Color{127, 70,  1  },
		cm::Color{91,  93,  0  },
		cm::Color{55,  112, 0  },
		cm::Color{28,  122, 6  },
		cm::Color{16,  119, 51 },
		cm::Color{17,  105, 118},
		cm::Color{19,  19,  19 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
		cm::Color{147, 147, 147},
		cm::Color{96,  120, 161},
		cm::Color{110, 110, 176},
		cm::Color{127, 102, 175},
		cm::Color{141, 98,  157},
		cm::Color{149, 99,  129},
		cm::Color{148, 105, 99 },
		cm::Color{139, 114, 76 },
		cm::Color{123, 124, 64 },
		cm::Color{107, 132, 65 },
		cm::Color{93,  137, 79 },
		cm::Color{86,  135, 105},
		cm::Color{87,  129, 135},
		cm::Color{88,  88,  88 },
		cm::Color{0,   0,   0  },
		cm::Color{0,   0,   0  },
	};

	ColorPalette ColorPalette::default_palette() noexcept
	{
		return ColorPalette(default_colors);
	}

	std::optional<ColorPalette> ColorPalette::from_file(const std::filesystem::path &path) noexcept
	{
		namespace fs = std::filesystem;

		try
		{
			if (path.extension() != ".pal")
			{
				LOG_WARN("Palette file should be a .pal file!");
				return std::nullopt;
			}

			auto status = fs::status(path);

			if (!fs::exists(status))
			{
				LOG_WARN("Palette file doesn't exist!");
				return std::nullopt;
			}

			if (!fs::is_regular_file(status))
			{
				LOG_WARN("Palette file doesn't exist!");
				return std::nullopt;
			}

			auto size = fs::file_size(path);

			if (size != 512 * 3)
			{
				LOG_WARN("unexpected palette file size, should be {} but is {}", 512 * 3, size);
				return std::nullopt;
			}

			auto file = std::basic_ifstream<uint8_t>(path, std::ios::binary);
			if (!file)
			{
				LOG_WARN("could not open file: {}", path.string());
				return std::nullopt;
			}

			file.exceptions(std::ios::badbit | std::ios::failbit);

			std::array<cm::Color, 512> new_palette;
			for (auto &c : new_palette)
			{
				c.a = 255;
				file.get(c.r);
				file.get(c.g);
				file.get(c.b);
			}

			LOG_INFO("Palette loaded: {}", path.string());
			return ColorPalette(new_palette);
		}
		catch (const std::exception &e)
		{
			LOG_WARN("Error loading palette '{}': {}", path.string(), e.what());
			return std::nullopt;
		}
	}

	ColorPalette::ColorPalette(std::span<cm::Color> colors) noexcept
		: palette(begin(colors), end(colors))
	{
		auto count = size(palette);
		if (count != 64 && count != 512)
			LOG_WARN("Palette has an unexpected number of entries, should be 512 (or 64 with no color emphasis), actual size: {}", count);
	}

	cm::Color ColorPalette::color_at_index(nesem::U16 color_index) const noexcept
	{
		return palette[color_index % size(palette)];
	}
}
